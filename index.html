<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saúde Inteligente</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="style.css">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

</head>
<body>

<header>
  <h1 style="color:white;">Saúde Inteligente</h1>
</header>

<section class="hero">
  <h2 id="cityTitle">Encontre hospitais próximos</h2>
  <p>Role para ver o mapa com hospitais da sua cidade.</p>
</section>

<div class="cards-container">
  <div class="card"><h3>Dica de saúde 1</h3><p>Alimente-se bem.</p></div>
  <div class="card"><h3>Dica de saúde 2</h3><p>Pratique exercícios.</p></div>
  <div class="card"><h3>Dica de saúde 3</h3><p>Faça consultas regulares.</p></div>
</div>

<section class="map-section" id="mapSection">
  <div id="map"></div>
</section>

<button id="historyBtn" onclick="openHistory()">Histórico</button>

<!-- MODAL CONTATO -->
<div id="contactModal" class="modal">
  <div class="modal-content">
    <span onclick="closeModal()" class="close-button">&times;</span>
    <h3>Entrar em contato</h3>
    
    <form id="contactForm" action="https://formspree.io/f/saude-inteligente" method="POST">
      <label>Hospital:</label>
      <input type="text" id="hospitalName" name="Hospital" readonly />

      <label>Nome:</label>
      <input type="text" name="Nome" required />

      <label>CPF:</label>
      <input type="text" name="CPF" required />

      <label>Email:</label>
      <input type="email" name="Email" required />

      <label>Mensagem:</label>
      <textarea name="Mensagem" required></textarea>

      <button type="submit">Enviar</button>
    </form>
  </div>
</div>

<!-- MODAL HISTÓRICO -->
<div id="historyModal" class="modal">
  <div class="modal-content">
    <span onclick="closeHistory()" class="close-button">&times;</span>
    <h3>Histórico de mensagens</h3>
    <ul id="messageHistory"></ul>
  </div>
</div>

<div id="responseToast" class="response-toast">
  <span id="responseText"></span>
</div>

<script>
let messageHistoryData = [];

let map;
let userMarker;
let accuracyCircle;
let hospitalMarkers = [];

async function fetchHospitals(lat, lon) {
  const radius = 10000;
  const query = `[out:json][timeout:25];
(
  node["amenity"="hospital"](around:${radius},${lat},${lon});
  way["amenity"="hospital"](around:${radius},${lat},${lon});
  relation["amenity"="hospital"](around:${radius},${lat},${lon});
);
out center;`;

  const res = await fetch('https://overpass-api.de/api/interpreter', {
    method: 'POST',
    body: query
  });

  const data = await res.json();

  return data.elements.map(el => {
    const nome = el.tags && el.tags.name ? el.tags.name : 'Hospital';
    const latlng = el.type === 'node' ? [el.lat, el.lon] : [el.center.lat, el.center.lon];
    return { nome, lat: latlng[0], lng: latlng[1] };
  });
}

function clearHospitalMarkers() {
  hospitalMarkers.forEach(m => map.removeLayer(m));
  hospitalMarkers = [];
}

function renderHospitals(lista) {
  clearHospitalMarkers();
  lista.forEach(h => {
    const marker = L.marker([h.lat, h.lng]).addTo(map);
    marker.bindPopup(`
      <b>${h.nome}</b><br>
      <button class='contactBtn' data-hospital="${h.nome}">Entrar em contato</button>
    `);

    marker.on("popupopen", e => {
      const btn = e.popup.getElement().querySelector(".contactBtn");
      if (btn) btn.onclick = () => openModal(btn.dataset.hospital);
    });

    hospitalMarkers.push(marker);
  });
}

function updateUserLocation(pos) {
  const { latitude, longitude, accuracy } = pos.coords;
  const latlng = [latitude, longitude];

  if (!userMarker) userMarker = L.marker(latlng).addTo(map);
  else userMarker.setLatLng(latlng);

  if (!accuracyCircle)
    accuracyCircle = L.circle(latlng, {
      radius: accuracy,
      color: '#2fad61',
      fillColor: '#6ee787',
      fillOpacity: 0.2
    }).addTo(map);
  else
    accuracyCircle.setLatLng(latlng).setRadius(accuracy);
}

async function updateCityAndHospitals(lat, lon) {
  try {
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=pt-BR`);
    const j = await r.json();
    const city = j.address.city || j.address.town || j.address.village || j.address.municipality || 'sua cidade';
    document.getElementById('cityTitle').textContent = `Encontre hospitais próximos em ${city}`;
  } catch {}

  try {
    const lista = await fetchHospitals(lat, lon);
    if (lista.length) renderHospitals(lista);
  } catch {}
}

function initMap() {
  map = L.map('map').setView([-23.4273, -51.9375], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      map.setView([latitude, longitude], 13);
      updateUserLocation(pos);
      updateCityAndHospitals(latitude, longitude);
    }, () => {
      updateCityAndHospitals(-23.4273, -51.9375);
    });

    navigator.geolocation.watchPosition(updateUserLocation, null, {
      enableHighAccuracy: true,
      maximumAge: 5000,
      timeout: 10000
    });
  } else {
    updateCityAndHospitals(-23.4273, -51.9375);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  loadHistory();
  initMap();
});

const modal = document.getElementById('contactModal');
const hospitalNameInput = document.getElementById('hospitalName');

function openModal(nome) {
  hospitalNameInput.value = nome;
  modal.classList.add('show');
}
function closeModal() {
  modal.classList.remove('show');
}

const historyModal = document.getElementById('historyModal');

function openHistory() {
  const ul = document.getElementById('messageHistory');
  ul.innerHTML = messageHistoryData
    .map(msg => `<li><b>${msg.hospital}</b> — ${msg.hora}<br>${msg.mensagem}</li>`)
    .join("");

  historyModal.classList.add('show');
}
function closeHistory() {
  historyModal.classList.remove('show');
}

function showToast(msg) {
  responseText.textContent = msg;
  responseToast.style.display = "block";
  setTimeout(() => responseToast.style.display = "none", 4000);
}

function saveHistory() {
  localStorage.setItem("history", JSON.stringify(messageHistoryData));
}
function loadHistory() {
  const d = localStorage.getItem("history");
  if (d) messageHistoryData = JSON.parse(d);
}

document.getElementById("contactForm").addEventListener("submit", e => {
  e.preventDefault();
  const form = e.target;
  const data = new FormData(form);

  const mensagem = data.get("Mensagem");
  const hospital = data.get("Hospital");
  const hora = new Date().toLocaleString("pt-BR");

  fetch(form.action, { method: "POST", body: data })
    .then(r => {
      if (r.ok) {
        messageHistoryData.push({ mensagem, hospital, hora });
        saveHistory();
        form.reset();
        closeModal();
        showToast("Mensagem enviada!");
      } else {
        showToast("Erro ao enviar.");
      }
    });
});
</script>

</body>
</html>


